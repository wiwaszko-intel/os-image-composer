image:
  name: minimal-desktop-ubuntu-ptl-dls
  version: "24.04"

target:
  os: ubuntu
  dist: ubuntu24
  arch: x86_64
  imageType: raw

# Disk layout and output artifact definition
disk:
  # Human friendly name logged by builders
  name: minimal-desktop-ubuntu-ptl-dls
  artifacts:
    # Request conversion to raw
    - type: raw
      compression: gz
  size: 16GiB
  # GPT partition table per installer spec
  partitionTableType: gpt
  partitions:
    # EFI system partition for bootloaders
    - id: EFI
      name: EFI
      type: esp
      # GPT type GUID for EFI system partition
      typeUUID: c12a7328-f81f-11d2-ba4b-00a0c93ec93b
      fsType: vfat
      # Builder expects explicit MiB offsets
      start: 1MiB
      end: 1025MiB
      mountPoint: /boot/efi
      mountOptions: defaults
      flags:
        - boot
        - esp
    # Root filesystem
    - id: ROOT
      name: ROOT
      type: linux-root-amd64
      # Standard Linux root filesystem GUID for x86_64
      typeUUID: 4f68bce3-e8cd-4db1-96e7-fbcaf984b709
      fsType: ext4
      start: 1025MiB
      end: "0"
      mountPoint: /
      mountOptions: defaults
      flags: []

# Additional package repositories for this image
packageRepositories:
  # GBNetwork mirror repositories with high priority to replace base repo
  - codename: "noble"
    url: "http://mirrors.gbnetwork.com/ubuntu"
    pkey: "/usr/share/keyrings/ubuntu-archive-keyring.gpg"
    component: "main restricted universe multiverse"
    priority: 900

  - codename: "noble-security"
    url: "http://security.ubuntu.com/ubuntu"
    pkey: "/usr/share/keyrings/ubuntu-archive-keyring.gpg"
    component: "main restricted universe multiverse"
    priority: 900

  - codename: "noble-updates"
    url: "http://mirrors.gbnetwork.com/ubuntu"
    pkey: "/usr/share/keyrings/ubuntu-archive-keyring.gpg"
    component: "main restricted universe multiverse"
    priority: 900

  - codename: "sed"
    url: "https://eci.intel.com/sed-repos/noble"
    pkey: "https://eci.intel.com/sed-repos/gpg-keys/GPG-PUB-KEY-INTEL-SED.gpg" # Uncomment and replace in real config
    priority: 1000  # Higher priority means preferred over other repos

  - codename: "ubuntu24"
    url: "https://apt.repos.intel.com/openvino/2025"
    pkey: "https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB" # Uncomment and replace in real config

  - codename: "noble"
    url: "https://af01p-png.devtools.intel.com/artifactory/hspe-edge-png-local/ubuntu/noble/noble/20260116-0012_2026_SW_A_REL1_RC02"
    pkey: "https://af01p-png.devtools.intel.com/artifactory/hspe-edge-png-local/ubuntu/keys/adl-hirsute-public.gpg" # Uncomment and replace in real config
    component: "main non-free multimedia internal"
    priority: 1001 # Higher priority means preferred over other repos

  - codename: "ubuntu24"
    url: "https://apt.repos.intel.com/edgeai/dlstreamer/ubuntu24"
    pkey: "https://apt.repos.intel.com/edgeai/dlstreamer/GPG-PUB-KEY-INTEL-DLS.gpg"

  - codename: "noble"
    url: "https://download.docker.com/linux/ubuntu"
    pkey: "https://download.docker.com/linux/ubuntu/gpg"
    component: "stable"

systemConfig:
  name: minimal
  description: Minimal desktop ubuntu image for PTL

  bootloader:
    bootType: efi
    provider: grub

  immutability:
    enabled: false # default is true

  packages:
    - bsdutils
    - cloud-utils
    - debianutils
    - diffutils
    - findutils
    - grep
    - grub-efi-amd64-signed
    - gzip
    - ibus-table-cangjie-big
    - ibus-table-cangjie3
    - ibus-table-cangjie5
    - init
    - language-pack-en
    - language-pack-en-base
    - language-pack-gnome-en
    - language-pack-gnome-en-base
    - libattr1
    - libchewing3
    - libchewing3-data
    - libm17n-0
    - libmarisa0
    - libopencc-data
    - libopencc1.1
    - libotf1
    - libpinyin-data
    - libpinyin15
    - linux-base
    - m17n-db
    - mawk
    - ncurses-base
    - ncurses-bin
    - python3-netifaces
    - shim-signed
    - ubuntu-desktop-minimal
    - ubuntu-minimal
    - ubuntu-standard
    - ubuntu-wallpapers
    - wbritish
    - gdm3
    - systemd
    - openssh-server
    - systemd-resolved
    - util-linux
    - udev
    - initramfs-tools
    - grub2-common
    - grub-pc-bin
    - grub-efi-amd64
    - grub-efi-amd64-bin
    - efibootmgr
    # PTL network stack
    - curl
    - wget
    - cron
    - ethtool
    - iproute2
    # PTL packages
    - vim
    - nano
    - ocl-icd-libopencl1
    - net-tools
    - libdrm-amdgpu1
    - libdrm-common
    - libdrm-dev
    - libdrm-intel1
    - libdrm-nouveau2
    - libdrm-radeon1
    - libdrm-tests
    - libdrm2
    - libgstreamer-plugins-good1.0-0
    - libgstreamer-plugins-good1.0-dev
    - libtpms-dev
    - libtpms0
    - libwayland-bin
    - libwayland-client0
    - libwayland-cursor0
    - libwayland-dev
    - libwayland-doc
    - libwayland-egl-backend-dev
    - libwayland-egl1
    - libwayland-server0
    - mesa-utils
    - ovmf
    - ovmf-ia32
    - xserver-xorg-core
    - libvirt0
    - libvirt-clients
    - libvirt-daemon
    - libvirt-daemon-config-network
    - libvirt-daemon-config-nwfilter
    - libvirt-daemon-driver-lxc
    - libvirt-daemon-driver-qemu
    - libvirt-daemon-driver-storage-gluster
    - libvirt-daemon-driver-storage-iscsi-direct
    - libvirt-daemon-driver-storage-rbd
    - libvirt-daemon-driver-storage-zfs
    - libvirt-daemon-driver-vbox
    - libvirt-daemon-driver-xen
    - libvirt-daemon-system
    - libvirt-daemon-system-systemd
    - libvirt-dev
    - libvirt-doc
    - libvirt-login-shell
    - libvirt-sanlock
    - libvirt-wireshark
    - libnss-libvirt
    - swtpm
    - swtpm-tools
    - bmap-tools
    - adb
    - autoconf
    - automake
    - libtool
    - cmake
    - g++
    - gcc
    - git
    - intel-gpu-tools
    - libssl3
    - libssl-dev
    - make
    - mosquitto
    - mosquitto-clients
    - build-essential
    - apt-transport-https
    - default-jre
    - git-lfs
    - gnuplot
    - lbzip2
    - libglew-dev
    - libglm-dev
    - libsdl2-dev
    - mc
    - openssl
    - pciutils
    - python3-pandas
    - python3-pip
    - python3-seaborn
    - terminator
    - wmctrl
    - gdbserver
    - iperf3
    - msr-tools
    - powertop
    - lsscsi
    - tpm2-tools
    - tpm2-abrmd
    - binutils
    - cifs-utils
    - i2c-tools
    - xdotool
    - gnupg
    - lsb-release
    - socat
    - virt-viewer
    - util-linux-extra
    - dbus-x11
    - sg3-utils
    - rpm
    - dash
    - hostname
    - login
    - passwd
    - sed
    - network-manager-config-connectivity-ubuntu
    - cloud-init
    - network-manager
    - systemd-timesyncd
    # Pinned versions
    - xdp-tools
    - mutter-common-bin_46.2-1.0.24.04.13-1ppa1~noble2
    - libmutter-14-0_46.2-1.0.24.04.13-1ppa1~noble2
    - gir1.2-mutter-14_46.2-1.0.24.04.13-1ppa1~noble2
    - libigdgmm-dev_22.8.2-1ppa1~noble2
    - libigdgmm12_22.8.2-1ppa1~noble2
    - libmfx-gen1.2_25.3.4-1ppa1~noble2
    - libva-dev_2.22.0-1ppa1~noble3
    - libva-drm2_2.22.0-1ppa1~noble3
    - libva-glx2_2.22.0-1ppa1~noble3
    - libva-wayland2_2.22.0-1ppa1~noble3
    - libva-x11-2_2.22.0-1ppa1~noble3
    - libva2_2.22.0-1ppa1~noble3
    - libxatracker2_25.0.0-1ppa1~noble9
    - linux-firmware_20240318.git3b128b60-0.2.17-1ppa1-noble12
    - mesa-va-drivers_25.0.0-1ppa1~noble9
    - mesa-vdpau-drivers_25.0.0-1ppa1~noble9
    - mesa-vulkan-drivers_25.0.0-1ppa1~noble9
    - libvpl-dev_1:2.15.0-1ppa1~noble2
    - libmfx-gen-dev_25.3.4-1ppa1~noble2
    - onevpl-tools_1:2.15.0-1ppa1~noble2
    - qemu-block-extra_4:9.1.0+git20251029-ppa1-noble3
    - qemu-guest-agent_4:9.1.0+git20251029-ppa1-noble3
    - qemu-system_4:9.1.0+git20251029-ppa1-noble3
    - qemu-system-arm_4:9.1.0+git20251029-ppa1-noble3
    - qemu-system-common_4:9.1.0+git20251029-ppa1-noble3
    - qemu-system-data_4:9.1.0+git20251029-ppa1-noble3
    - qemu-system-gui_4:9.1.0+git20251029-ppa1-noble3
    - qemu-system-mips_4:9.1.0+git20251029-ppa1-noble3
    - qemu-system-misc_4:9.1.0+git20251029-ppa1-noble3
    - qemu-system-ppc_4:9.1.0+git20251029-ppa1-noble3
    - qemu-system-s390x_4:9.1.0+git20251029-ppa1-noble3
    - qemu-system-sparc_4:9.1.0+git20251029-ppa1-noble3
    - qemu-system-x86_4:9.1.0+git20251029-ppa1-noble3
    - qemu-user_4:9.1.0+git20251029-ppa1-noble3
    - qemu-user-binfmt_4:9.1.0+git20251029-ppa1-noble3
    - qemu-utils_4:9.1.0+git20251029-ppa1-noble3
    - qemu-system-modules-opengl_4:9.1.0+git20251029-ppa1-noble3
    - va-driver-all_2.22.0-1ppa1~noble3
    - weston_10.0.0+git20250321-1ppa1~noble6
    - wayland-protocols_1.38-1ppa1~noble3
    - linuxptp_4.3-ppa1~noble2
    - libvpl-tools_2:1.4.0~1ppa1-noble2
    - spice-client-gtk_0.42-1ppa1~noble4
    - intel-media-va-driver-non-free_25.3.4-1ppa1~noble5
    - gir1.2-gst-plugins-bad-1.0_1.26.5-1ppa1~noble13
    - gir1.2-gst-plugins-base-1.0_1.26.5-1ppa1~noble3
    - gir1.2-gstreamer-1.0_1.26.5-1ppa1~noble3
    - gir1.2-gst-rtsp-server-1.0_1.26.5-1ppa1~noble2
    - gstreamer1.0-alsa_1.26.5-1ppa1~noble3
    - gstreamer1.0-gl_1.26.5-1ppa1~noble3
    - gstreamer1.0-gtk3_1.26.5-1ppa1~noble3
    - gstreamer1.0-opencv_1.26.5-1ppa1~noble13
    - gstreamer1.0-plugins-bad_1.26.5-1ppa1~noble13
    - gstreamer1.0-plugins-bad-apps_1.26.5-1ppa1~noble13
    - gstreamer1.0-plugins-base_1.26.5-1ppa1~noble3
    - gstreamer1.0-plugins-base-apps_1.26.5-1ppa1~noble3
    - gstreamer1.0-plugins-good_1.26.5-1ppa1~noble3
    - gstreamer1.0-plugins-ugly_1.26.5-1ppa1~noble2
    - gstreamer1.0-pulseaudio_1.26.5-1ppa1~noble3
    - gstreamer1.0-qt5_1.26.5-1ppa1~noble3
    - gstreamer1.0-rtsp_1.26.5-1ppa1~noble2
    - gstreamer1.0-tools_1.26.5-1ppa1~noble3
    - gstreamer1.0-x_1.26.5-1ppa1~noble3
    - libgstrtspserver-1.0-dev_1.26.5-1ppa1~noble2
    - libgstrtspserver-1.0-0_1.26.5-1ppa1~noble2
    - libgstreamer-gl1.0-0_1.26.5-1ppa1~noble3
    - libgstreamer-opencv1.0-0_1.26.5-1ppa1~noble13
    - libgstreamer-plugins-bad1.0-0_1.26.5-1ppa1~noble13
    - libgstreamer-plugins-bad1.0-dev_1.26.5-1ppa1~noble13
    - libgstreamer-plugins-base1.0-0_1.26.5-1ppa1~noble3
    - libgstreamer-plugins-base1.0-dev_1.26.5-1ppa1~noble3
    - libgstreamer1.0-0_1.26.5-1ppa1~noble3
    - libgstreamer1.0-dev_1.26.5-1ppa1~noble3
    - vainfo_2.22.0-1ppa1~noble1
    - ffmpeg_7:8.0.0-1ppa1~noble1
    - xpu-smi_1.3.0-20250707.103634.3db7de07~u24.04
    - intel-ocloc_25.40.35563.4-0
    - libze-intel-gpu1_25.40.35563.4-0
    - intel-metrics-discovery_1.14.180-1
    - intel-metrics-library_1.0.196-1
    - intel-gsc_0.9.5-1ppa1~noble1
    - level-zero_1.22.4
    - intel-igc-core-2_2.20.3
    - intel-igc-opencl-2_2.20.3
    - intel-opencl-icd_25.40.35563.4-0
    - xserver-common_2:21.1.12-1ppa1~noble3
    - xnest_2:21.1.12-1ppa1~noble3
    - xserver-xorg-dev_2:21.1.12-1ppa1~noble3
    - xvfb_2:21.1.12-1ppa1~noble3
    #dls based pkg
    - docker.io
    - docker-compose-plugin
    - intel-dlstreamer

  additionalFiles:
    - local: ../additionalfiles/ptl/01-network-manager-all.yaml
      final: /etc/netplan/01-network-manager-all.yaml
    - local: ../additionalfiles/ptl/50-cloud-init.yaml
      final: /etc/netplan/50-cloud-init.yaml
    
  kernel:
    version: "6.17"
    # Use this cmdline and kernel option if using xe driver,
    cmdline: "console=ttyS0,115200 console=tty0 loglevel=7 xe.max_vfs=7 xe.force_probe=* modprobe.blacklist=i915 udmabuf.list_limit=8192"
    enableExtraModules: "intel_vpu uas"
    # Use this cmdline and kernel option if using i915 driver,
    # cmdline: "console=ttyS0,115200 console=tty0 loglevel=7 i915.force_probe=*"
    # enableExtraModules: "intel_vpu uas"
    # alternative cmdline in case gpu not support both i915 and xe drivers
    # cmdline: "console=ttyS0,115200 console=tty0 loglevel=7"
    # enableExtraModules: "intel_vpu uas simpledrm"
    packages:
        - linux-image-6.17-intel_260128t080735z-r2
        - linux-headers-6.17-intel_260128t080735z-r2

  users:
    - name: rbfadmin
      password: "jaiZ6dai"
    - name: user
      password: user1234
      groups: ["sudo"]
    - name: vpu-user
      password: vpu-user
      groups: ["render"]
    - name: sys_olvtelemetry

  configurations:
    # Set up APT proxies
    - cmd: "echo 'Acquire::ftp::Proxy \"http://proxy-dmz.intel.com:911\";' > /etc/apt/apt.conf.d/99proxy.conf"
    - cmd: "echo 'Acquire::http::Proxy \"http://proxy-dmz.intel.com:911\";' >> /etc/apt/apt.conf.d/99proxy.conf"
    - cmd: "echo 'Acquire::https::Proxy \"http://proxy-dmz.intel.com:911\";' >> /etc/apt/apt.conf.d/99proxy.conf"
    - cmd: "echo 'Acquire::https::proxy::af01p-png.devtools.intel.com \"DIRECT\";' >> /etc/apt/apt.conf.d/99proxy.conf"
    - cmd: "echo 'Acquire::https::proxy::ubit-artifactory-or.intel.com \"DIRECT\";' >> /etc/apt/apt.conf.d/99proxy.conf"
    - cmd: "echo 'Acquire::https::proxy::*.intel.com \"DIRECT\";' >> /etc/apt/apt.conf.d/99proxy.conf"
    # Set environment proxies
    - cmd: "echo 'http_proxy=http://proxy-dmz.intel.com:911' >> /etc/environment"
    - cmd: "echo 'https_proxy=http://proxy-dmz.intel.com:912' >> /etc/environment"
    - cmd: "echo 'ftp_proxy=http://proxy-dmz.intel.com:911' >> /etc/environment"
    - cmd: "echo 'socks_server=http://proxy-dmz.intel.com:1080' >> /etc/environment"
    - cmd: "echo 'no_proxy=localhost,127.0.0.1,127.0.1.1,127.0.0.0/8,172.16.0.0/20,192.168.0.0/16,10.0.0.0/8,10.1.0.0/16,10.152.183.0/24,devtools.intel.com,jf.intel.com,teamcity-or.intel.com,caas.intel.com,inn.intel.com,isscorp.intel.com,gfx-assets.fm.intel.com' >> /etc/environment"
    # Configure SSH keys for sys_olvtelemetry user
    - cmd: "mkdir -m 700 -p ~sys_olvtelemetry/.ssh"
    - cmd: "echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOPEVYF28+I92b3HFHOSlPQXt3kHXQ9IqtxFE4/0YkK5 swsbalabuser@BA02RNL99999' > ~sys_olvtelemetry/.ssh/authorized_keys"
    - cmd: "echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDb2P8gBvsy9DkzC1WiXfvisMFf7PQvtdvVC4n22ot4D5KOVxgoaCnjZM6qAZ2AdWPBebxInnUeMvw0u6RjRnflpYtNPgN4qiE313j62CmD80f/N+jvIxmoGhgsGE4RAMFXQ6pNaB/8KblrpmWQ5VfEIt7JcSR3Qvnkl9I2bljJU9zrMieE+Nras7hstg8fVWtGNjQjJpMWmt1YGxVbQiea0jDBqpru6TqnOYGD48JdR8QzHq++xL82I3x8kPz6annAvCDSVmiw9Mz0YtAsPIDZj4ABm866a8/U2mKVUncXYrBG1/pHBJMDJeX3ggd/UK2NvU8uEDJmITXUZRP8kBaO7b2LnRO08+Pr+nvmwukCP/wXflfS59h7kXCo8+Xjx/PEMO4OyFYHQunOUf/XTC13iig/MLY0EbqU6D+Lg1N13eJocRSta50zV+m+/PG23Zd3/6UH0noxYezQV3dQmsstzKKXbm8vkBmdqCZEvEnFSgl0VmX5HpzZLYI3L3hBH8/wgiWinrs7K13pZ8+lXN0ZhhJhdo61juiYwy1gbHP0ihqGkePw7w0DSCu5s9fA7xDTy2YTjkMsKaT8rbTYG5hunokNswdOCNYJyiCF3zJ08Z5hlDqSJJOPRdjL3YTIr6QlWSea/pTjkWmmE7Mv8M15c4V8Y77x6DsTFWlmGQbf1Q== swsbalabuser@BA02RNL99999' >> ~sys_olvtelemetry/.ssh/authorized_keys"
    - cmd: "chmod 600 ~sys_olvtelemetry/.ssh/authorized_keys"
    - cmd: "chown sys_olvtelemetry:sys_olvtelemetry -R ~sys_olvtelemetry/.ssh"
    # Enable SSH service to start automatically on boot
    - cmd: "ln -sf /lib/systemd/system/ssh.service /etc/systemd/system/multi-user.target.wants/ssh.service"
    # Install NPU driver via dpkg per script-1
    - cmd: "mkdir -p /tmp/npu-drv-package"
    - cmd: "cd /tmp/npu-drv-package && wget https://af01p-ir.devtools.intel.com/artifactory/drivers_vpu_linux_client-ir-local/builds/opensource-linux-vpu-driver/ci/opensource_main/npu-linux-driver-ci-1.28.0.20251218-20347000698/linux-npu-driver-v1.28.0.20251218-20347000698-ubuntu2404.tar.gz"
    - cmd: "cd /tmp/npu-drv-package && tar -xf linux-npu-driver-v1.28.0.20251218-20347000698-ubuntu2404.tar.gz"
    - cmd: "cd /tmp/npu-drv-package && dpkg -i *.deb"
    # Install audio firmware
    - cmd: "mkdir -pv /lib/firmware/intel/sof-ipc4/mtl/ /lib/firmware/intel/sof-ace-tplg/"
    - cmd: "wget https://af01p-png.devtools.intel.com/artifactory/hspe-edge-png-local/ubuntu-mtl-audio-tplg-6/c0/intel/sof-ipc4/mtl/sof-mtl.ldc -O /lib/firmware/intel/sof-ipc4/mtl/sof-mtl.ldc"
    - cmd: "wget https://af01p-png.devtools.intel.com/artifactory/hspe-edge-png-local/ubuntu-mtl-audio-tplg-6/c0/intel/sof-ipc4/mtl/sof-mtl.ri -O /lib/firmware/intel/sof-ipc4/mtl/sof-mtl.ri"
    - cmd: "wget https://af01p-png.devtools.intel.com/artifactory/hspe-edge-png-local/ubuntu-mtl-audio-tplg-6/c0/intel/sof-ace-tplg/sof-mtl-rt711-4ch.tplg -O /lib/firmware/intel/sof-ace-tplg/sof-mtl-rt711-4ch.tplg"
    - cmd: "wget https://af01p-png.devtools.intel.com/artifactory/hspe-edge-png-local/ubuntu-mtl-audio-tplg-6/c0/intel/sof-ace-tplg/sof-mtl-rt711.tplg -O /lib/firmware/intel/sof-ace-tplg/sof-mtl-rt711.tplg"
    - cmd: "wget https://af01p-png.devtools.intel.com/artifactory/hspe-edge-png-local/ubuntu-mtl-audio-tplg-6/c0/intel/sof-ace-tplg/sof-hda-generic.tplg -O /lib/firmware/intel/sof-ace-tplg/sof-hda-generic.tplg"
    - cmd: "wget https://af01p-png.devtools.intel.com/artifactory/hspe-edge-png-local/ubuntu-mtl-audio-tplg-6/c0/intel/sof-ace-tplg/sof-mtl-es83x6-ssp1-hdmi-ssp02.tplg -O /lib/firmware/intel/sof-ace-tplg/sof-mtl-es83x6-ssp1-hdmi-ssp02.tplg"
    - cmd: "wget https://af01p-png.devtools.intel.com/artifactory/hspe-edge-png-local/ubuntu-mtl-audio-tplg-6/c0/intel/sof-ace-tplg/sof-mtl-hdmi-ssp02.tplg -O /lib/firmware/intel/sof-ace-tplg/sof-mtl-hdmi-ssp02.tplg"
    # Configure Wayland
    - cmd: "sed -i 's/#WaylandEnable=/WaylandEnable=/g' /etc/gdm3/custom.conf"
    # Disable auto-updates
    # - cmd: "sed -i 's/\"1\"/\"0\"/g' /etc/apt/apt.conf.d/20auto-upgrades"
    # Configure bash environment
    - cmd: "echo 'source /etc/profile.d/mesa_driver.sh' | tee -a /etc/bash.bashrc"
    - cmd: "echo 'set enable-bracketed-paste off' >> /etc/inputrc"
    # Configure automatic login
    - cmd: "sed -i 's/.*AutomaticLoginEnable =.*/AutomaticLoginEnable = true/g' /etc/gdm3/custom.conf"
    - cmd: "sed -i 's/.*AutomaticLogin = user1/AutomaticLogin = user/g' /etc/gdm3/custom.conf"
    # Configure sudo permissions
    - cmd: "echo 'sys_olvtelemetry ALL=(ALL) NOPASSWD: /usr/sbin/biosdecode, /usr/sbin/dmidecode, /usr/sbin/ownership, /usr/sbin/vpddecode' > /etc/sudoers.d/user-sudo"
    - cmd: "echo 'user ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers.d/user-sudo"
    - cmd: "chmod 440 /etc/sudoers.d/user-sudo"
    # Configure kernel messages
    - cmd: "echo 'kernel.printk = 7 4 1 7' > /etc/sysctl.d/99-kernel-printk.conf"
    - cmd: "echo 'kernel.dmesg_restrict = 0' >> /etc/sysctl.d/99-kernel-printk.conf"
    # Configure NTP and timezone for correct datetime
    - cmd: "ln -sf /usr/share/zoneinfo/UTC /etc/localtime"
    - cmd: "ln -sf /lib/systemd/system/systemd-timesyncd.service /etc/systemd/system/sysinit.target.wants/systemd-timesyncd.service"
    # Set up snap proxy refresh
    - cmd: "echo '#!/bin/bash' > /opt/snapd_refresh.sh"
    - cmd: "echo 'snap set system proxy.http=http://proxy-dmz.intel.com:911' >> /opt/snapd_refresh.sh"
    - cmd: "echo 'snap set system proxy.https=http://proxy-dmz.intel.com:912' >> /opt/snapd_refresh.sh"
    - cmd: "echo 'sleep 60 && snap refresh snapd-desktop-integration' >> /opt/snapd_refresh.sh"
    - cmd: "chmod +x /opt/snapd_refresh.sh"
    - cmd: "(crontab -l 2>/dev/null; echo '@reboot sudo /opt/snapd_refresh.sh 2>&1 | tee /opt/snapd_refresh_logs.txt') | crontab -"
    # Set build timestamp. Note: BUILD_TIME is captured at image build time (image creation), not at deployment/runtime.
    - cmd: "echo \"BUILD_TIME=$(date +%Y%m%d-%H%M)\" > /opt/jenkins-build-timestamp"
    - cmd: "echo 'PLATFORM=PTL' >> /opt/jenkins-build-timestamp"
    - cmd: "echo 'PTL KERNEL=mainline-tracking-6.17' >> /opt/jenkins-build-timestamp"

