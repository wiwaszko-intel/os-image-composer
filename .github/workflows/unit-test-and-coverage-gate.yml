name: Unit Tests and Coverage

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch or SHA to test"
        required: false
      cov_threshold:
        description: "Override coverage threshold (%)"
        required: false

concurrency:
  group: unit-tests-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write  # Needed to push threshold updates

jobs:
  test:
    name: Unit Tests & Coverage Gate
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.ref || github.event.pull_request.head.sha || github.sha }}

      - name: Setup Earthly
        uses: earthly/actions/setup-earthly@v1
        with:
          version: "latest"

      - name: Configure test parameters
        id: config
        run: |
          # Read threshold from file, allow manual override
          FILE_THRESHOLD=$(cat .coverage-threshold 2>/dev/null || echo "65.0")
          COV_THRESHOLD="${{ inputs.cov_threshold }}"
          COV_THRESHOLD="${COV_THRESHOLD:-$FILE_THRESHOLD}"
          echo "cov_threshold=${COV_THRESHOLD}" >> "$GITHUB_OUTPUT"
          echo "build_id=${GITHUB_RUN_ID}" >> "$GITHUB_OUTPUT"
          echo "::notice::Coverage threshold: ${COV_THRESHOLD}% (from ${{ inputs.cov_threshold && 'manual override' || '.coverage-threshold file' }})"

      - name: Run tests with coverage
        id: test
        run: |
          earthly +test \
            --COV_THRESHOLD="${{ steps.config.outputs.cov_threshold }}" \
            --PRINT_TS="${{ steps.config.outputs.build_id }}" \
            --FAIL_ON_NO_TESTS="false"

      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ github.run_id }}
          path: |
            coverage.out
            coverage_report.txt
          retention-days: 30

      - name: Generate coverage summary
        if: always()
        run: |
          {
            echo "## ðŸ“Š Test Coverage Report"
            echo ""
            
            # Extract overall coverage
            if [[ -f coverage_report.txt ]]; then
              # Format: **Overall Coverage:** 66.4%
              OVERALL=$(grep "Overall Coverage:" coverage_report.txt | sed 's/.*:\*\* //' | sed 's/%.*//')%
              THRESHOLD=$(grep "Threshold:" coverage_report.txt | sed 's/.*:\*\* //' | sed 's/%.*//')%
              STATUS=$(grep "Status:" coverage_report.txt | sed 's/.*:\*\* //')
              
              # Status badge
              if [[ "$STATUS" == "PASSED" ]]; then
                echo "| Metric | Value | Status |"
                echo "|--------|-------|--------|"
                echo "| **Overall Coverage** | $OVERALL | âœ… PASSED |"
                echo "| **Threshold** | $THRESHOLD | - |"
                echo "| **Build** | #${{ github.run_id }} | - |"
              else
                echo "| Metric | Value | Status |"
                echo "|--------|-------|--------|"
                echo "| **Overall Coverage** | $OVERALL | âŒ FAILED |"
                echo "| **Threshold** | $THRESHOLD | - |"
                echo "| **Build** | #${{ github.run_id }} | - |"
              fi
              echo ""
              
              # Failed tests section
              if grep -q "Failed Tests:" coverage_report.txt; then
                echo "### âŒ Failed Tests"
                echo ""
                sed -n '/\*\*Failed Tests:\*\*/,/^\*\*Note/p' coverage_report.txt | grep "â€¢" | head -20
                echo ""
              fi
              
              # Directory results table
              if grep -q "| Directory" coverage_report.txt; then
                echo "### ðŸ“ Directory Results"
                echo ""
                sed -n '/| Directory/,/^$/p' coverage_report.txt | head -50
                echo ""
              fi
            else
              echo "âš ï¸ Coverage report not generated"
              echo ""
              echo "Check the workflow logs for details."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Auto-update coverage threshold (ratchet)
        if: success() && github.ref != 'refs/heads/main'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -x  # Debug: show commands
          
          # Determine branch name based on event type
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BRANCH="${{ github.head_ref }}"
          else
            # For workflow_dispatch or other events, use ref_name
            BRANCH="${{ github.ref_name }}"
          fi
          
          echo "Target branch: ${BRANCH}"
          
          # Skip if on main branch (shouldn't happen due to condition, but safety check)
          if [[ "$BRANCH" == "main" ]]; then
            echo "Skipping ratchet on main branch"
            exit 0
          fi
          
          # Get current coverage from report
          CURRENT=$(grep "Overall Coverage:" coverage_report.txt | sed 's/.*:\*\* //' | sed 's/%.*//')
          OLD_THRESHOLD=$(cat .coverage-threshold 2>/dev/null || echo "0")
          
          echo "Current coverage: ${CURRENT}%"
          echo "Current threshold: ${OLD_THRESHOLD}%"
          
          # Calculate new threshold (0.5% buffer below actual coverage)
          # Use printf to ensure consistent one-decimal-place formatting
          NEW_THRESHOLD=$(printf '%.1f' "$(echo "$CURRENT - 0.5" | bc -l)")
          
          echo "Proposed new threshold: ${NEW_THRESHOLD}%"
          
          # Only update if new threshold is higher than old threshold
          if (( $(echo "$NEW_THRESHOLD > $OLD_THRESHOLD" | bc -l) )); then
            echo "Updating threshold: ${OLD_THRESHOLD}% -> ${NEW_THRESHOLD}%"
            echo "${NEW_THRESHOLD}" > .coverage-threshold
            
            # Configure git
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            # Fetch and checkout the branch
            git fetch origin "${BRANCH}"
            git checkout "${BRANCH}"
            
            # Stage and commit
            git add .coverage-threshold
            git commit -m "chore: auto-update coverage threshold to ${NEW_THRESHOLD}% (was ${OLD_THRESHOLD}%)"
            git push origin "${BRANCH}"
            
            echo "::notice::Coverage threshold updated to ${NEW_THRESHOLD}% on branch ${BRANCH}"
          else
            echo "New threshold (${NEW_THRESHOLD}%) is not higher than current (${OLD_THRESHOLD}%), no update needed"
          fi
